<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Message Application</title>
  </head>
  <body>
    <pre id="log" style="border:1px solid #000;padding:10px;margin-bottom:10px;"></pre>
    <div style="border:1px solid #000;padding:10px;margin-bottom:10px;">
      <b>Message Application</b><br/><br/>
      <button onclick="createMessage();" type="button">create message</button>
      <br/><br/>
      <table border=1>
        <thead>
          <tr>
            <td>
              Message
            </td>
            <td>
              Edit
            </td>
            <td>
              Delete
            </td>
          </tr>
        </thead>
        <tbody id="message-list">

        </tbody>
      </table>
    </div>
    <a href="/">back</a>
    <script type="text/javascript" src="/resources/qwest/js/qwest.min.js"></script>
    <script type="text/javascript" src="/resources/log/js/log.js"></script>
    <script>

      var messageListEl = document.getElementById("message-list");

      function createMessage(){
        var message = prompt("Enter message", "Message...");
        if (message != null) {
          // send to server
          qwest.put("/message",{"message":message},{"dataType":"json","responseType":"json"})
           .then(function(xhr, response) {
             if (!response["error"]){
               printMessages(response["data"]);
             }
             log(response);
           })
           .catch(function(e, xhr, response) {
              log({"error":"","error_description":"Error creating message"});
           });
        }
      };

      function editMessage(el){
        var trEl = el.parentElement.parentElement;

        var messageKey = trEl.getAttribute("message-key");
        var text = trEl.firstElementChild.innerHTML;
        var message = prompt("Edit message:",text);
        if (message != null) {
          // send to server
          qwest.post("/message/edit",{"message":message,"key":messageKey},{"dataType":"json","responseType":"json"})
           .then(function(xhr, response) {
             if (!response["error"]){
               printMessages(response["data"]);
             }
             log(response);
           })
           .catch(function(e, xhr, response) {
              log({"error":"","error_description":"Error editing message"});
           });
        }
      };

      function listMessages(){
        // send to server
        qwest.post("/message/list",null,{"responseType":"json"})
         .then(function(xhr, response) {
           if (!response["error"]){
             printMessages(response["data"]);
           }
           log(response);
         })
         .catch(function(e, xhr, response) {
            log({"error":"","error_description":"Error listing messages."});
         });
      };

      function printMessages(messages){
        var len = messages.length;
        var html = "";
        var message = null;
        while(len--){
          message = messages[len];
          html += "<tr message-key=\"" + message["key"] + "\"><td>" + message["text"] + "</td><td><button onclick=\"editMessage(this)\" type=\"button\">Edit message</button></td><td><button onclick=\"deleteMessage(this)\" type=\"button\">Delete message</button></td></tr>";
        }
        messageListEl.innerHTML = html;
      };

      function deleteMessage(el){
        var trEl = el.parentElement.parentElement;

        var messageKey = trEl.getAttribute("message-key");

        qwest.delete("/message",{"key":messageKey},{"dataType":"json","responseType":"json"})
         .then(function(xhr, response) {
           if (!response["error"]){
             printMessages(response["data"]);
           }
           log(response);
         })
         .catch(function(e, xhr, response) {
            log({"error":"","error_description":"Error deleting message"});
         });
      }

      window.onload = function(){
        listMessages();
        log();
      };

    </script>
  </body>
</html>
